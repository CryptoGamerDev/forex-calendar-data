name: Update and Clean Forex Calendar Data

on:
  schedule:
    - cron: '0 */2 * * *'  # Aktualizuj co 2 godziny
  workflow_dispatch:        # Ręczne uruchomienie

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT }}

      - name: Update and Clean Forex Data
        run: |
          # Pobierz surowe dane
          echo "Downloading raw data..."
          curl -s "https://nfs.faireconomy.media/ff_calendar_thisweek.csv" -o forex_data_raw.csv
          
          # Utwórz OCZYSZCZONY plik CSV z nowymi nagłówkami (BEZ FILTROWANIA ILOŚCI)
          echo "Creating cleaned CSV..."
          {
            # Nagłówki dla MT5 (bez URL)
            echo "Title,Country,Date,Time,Impact,Forecast,Previous"
            
            # Przepisz WSZYSTKIE dane, pomijając tylko kolumnę URL
            tail -n +2 forex_data_raw.csv | while IFS= read -r line; do
              # Zastąp przecinki wewnątrz pól, aby uniknąć problemów z podziałem
              clean_line=$(echo "$line" | sed 's/","/@%@%/g' | sed 's/,/ /g' | sed 's/@%@%/,/g')
              
              # Użyj przecinka jako separatora i przepisz tylko pierwsze 7 pól
              echo "$clean_line" | awk -F',' '{for(i=1;i<=7;i++) printf "%s%s", $i, (i<7 ? "," : "\n")}'
            done
          } > forex_data.csv
          
          # Sprawdź rozmiary plików
          raw_lines=$(wc -l < forex_data_raw.csv)
          cleaned_lines=$(wc -l < forex_data.csv)
          echo "Raw data lines: $raw_lines"
          echo "Cleaned data lines: $cleaned_lines"
          
          # Sprawdź zawartość
          echo "First few lines of cleaned file:"
          head -5 forex_data.csv

      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add forex_data_raw.csv forex_data.csv
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update cleaned forex calendar data [$(date +%Y-%m-%d)]" && git push)
