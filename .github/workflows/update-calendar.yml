name: Update and Filter Forex Calendar Data

on:
  schedule:
    - cron: '0 */2 * * *'  # Aktualizuj co 2 godziny
  workflow_dispatch:        # Ręczne uruchomienie

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT }}

      - name: Update and Filter Forex Data
        run: |
          # Pobierz surowe dane
          echo "Downloading raw data..."
          curl -s "https://nfs.faireconomy.media/ff_calendar_thisweek.csv" -o forex_data_raw.csv
          
          # Utwórz przefiltrowany plik CSV z nowymi nagłówkami
          echo "Creating filtered CSV..."
          {
            # Nagłówki dla MT5 (bez URL)
            echo "Title,Country,Date,Time,Impact,Forecast,Previous"
            
            # Pomijamy pierwszą linię (nagłówki) i filtrujemy dane
            tail -n +2 forex_data_raw.csv | while IFS= read -r line; do
              # Podziel linię na pola
              IFS=',' read -r -a fields <<< "$line"
              
              # Sprawdź czy mamy wystarczającą liczbę pól
              if [ ${#fields[@]} -ge 8 ]; then
                title="${fields[0]}"
                country="${fields[1]}"
                date="${fields[2]}"
                time="${fields[3]}"
                impact="${fields[4]}"
                forecast="${fields[5]}"
                previous="${fields[6]}"
                
                # Filtruj: pomiń Low impact z pustymi danymi
                if [ "$impact" = "Low" ] && [ -z "$forecast" ] && [ -z "$previous" ]; then
                  continue
                fi
                
                # Zapisz przefiltrowane dane
                echo "$title,$country,$date,$time,$impact,$forecast,$previous"
              fi
            done
          } > forex_data_filtered.csv
          
          # Sprawdź rozmiary plików
          raw_lines=$(($(wc -l < forex_data_raw.csv)-1))
          filtered_lines=$(($(wc -l < forex_data_filtered.csv)-1))
          echo "Raw data lines: $raw_lines"
          echo "Filtered data lines: $filtered_lines"
          echo "Reduction: $((raw_lines - filtered_lines)) events removed"

      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add forex_data_raw.csv forex_data_filtered.csv
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update filtered forex calendar data [$(date +%Y-%m-%d)]" && git push)
